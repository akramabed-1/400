<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>400 PRO Scoreboard</title>
  <style>
    html, body { margin: 0; padding: 0; background: #0b5b2e; font-family: sans-serif; overflow-x: hidden; }
    #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #064020; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 1s ease-in-out; text-align: center; }
    #splash h1 { color: #ffd54f; font-size: 3.5rem; font-weight: 900; margin: 0; }
    #match-header { position: fixed; top: 0; width: 100%; background: #064020; border-bottom: 3px solid #ffd54f; display: flex; justify-content: space-around; align-items: center; z-index: 100; height: 60px; }
    .score-box { min-width: 50px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; color: #fff; }
    .bg-red { background: #d32f2f; border: 2px solid white; }
    .bg-black { background: #000; border: 2px solid #555; }
    .alz-btn { position: fixed; top: 68px; right: 10px; background: #ff5252; color: white; border: 2px solid white; border-radius: 8px; font-weight: 900; font-size: 0.65rem; padding: 8px 0; width: 75px; text-align: center; cursor: pointer; z-index: 200; text-transform: uppercase; display: none; }
    .main-wrapper { display: flex; flex-direction: column; align-items: center; padding-top: 75px; }
    .table-area { position: relative; width: 100%; height: 650px; display: flex; justify-content: center; align-items: center; }
    .card-table { position: relative; width: 95%; max-width: 400px; height: 420px; background: radial-gradient(circle, #0f7b3c 0, #064020 85%); border-radius: 50px; display: flex; align-items: center; justify-content: center; }
    .center-panel { background: rgba(0,0,0,0.95); padding: 15px 5px; border-radius: 12px; text-align: center; width: 115px; border: 3px solid #ffd54f; z-index: 100; }
    .main-btn { background: #ffd54f; color: black; border: none; border-radius: 5px; font-weight: 900; width: 90%; margin: 5px 0; font-size: 0.9rem; padding: 10px 0; cursor: pointer; text-transform: uppercase; }
    .gray-btn { background: #666 !important; color: white !important; }
    .player-panel { position: absolute; background: white; color: #222; border-radius: 15px; width: 125px; height: 195px; text-align: center; display: flex; flex-direction: column; overflow: hidden; border: 4px solid transparent; box-sizing: border-box; }
    .dealer-active { border-color: #ffd54f !important; transform: scale(1.05); z-index: 50; }
    .player-right { left: calc(50% + 65px); top: 50%; transform: translateY(-50%); }
    .player-left { left: calc(50% - 190px); top: 50%; transform: translateY(-50%); }
    .player-top { top: -110px; left: 50%; transform: translateX(-50%); }
    .player-bottom { bottom: -110px; left: 50%; transform: translateX(-50%); }
    .p-name { border: none; background: transparent; font-weight: 900; width: 100%; font-size: 0.95rem; text-align: center; }
    .bid-sel { width: 100%; border-radius: 6px; border: 2px solid #ffd54f; font-size: 20px; font-weight: bold; height: 32px; }
    .res-btn { width: 42px; height: 38px; border-radius: 6px; font-weight: 900; border: 1px solid #ccc; background: #fff; }
    .p-tot-display { font-size: 2.2rem; font-weight: 900; background: #f0f0f0; border-top: 1px solid #ddd; padding: 6px 0; }
    .hist-container { width: 100%; background: #000; border-top: 4px solid #ffd54f; padding-bottom: 80px; }
    table { width: 100%; border-collapse: collapse; text-align: center; color: white; }
    th { background: #111; color: #ffd54f; padding: 12px; }
    td { padding: 12px; border-bottom: 1px solid #222; }
    #win-banner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #fff; padding: 25px; border-radius: 20px; text-align: center; z-index: 1000; border: 5px solid #ffd54f; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
  </style>
</head>
<body>

  <div id="splash"><h1>400 PRO</h1><h2>SCOREBOARD</h2></div>

  <div id="match-header">
    <div style="display:flex; align-items:center; gap:5px;"><span style="color:#ffd54f; font-weight:900;">RED</span><div class="score-box bg-red" id="m1">0</div></div>
    <select id="match-type-select" style="background: #222; color: #ffd54f; border: 1px solid #ffd54f; height: 35px; font-weight:bold;">
      <option value="1">SINGLE</option><option value="2">BO3</option><option value="3">BO5</option>
    </select>
    <div style="display:flex; align-items:center; gap:5px;"><div class="score-box bg-black" id="m2">0</div><span style="color:#ffd54f; font-weight:900;">BLACK</span></div>
  </div>

  <button class="alz-btn" id="alz-btn" onclick="moveDealer()">ALZHEIMER</button>

  <div class="main-wrapper">
    <div class="table-area">
      <div class="card-table">
        <div class="center-panel">
          <div id="rd-info" style="color:#ffd54f; font-weight:bold; font-size: 0.95rem; margin-bottom: 4px;">RD 1 (11)</div>
          <button id="bid-btn" class="main-btn" onclick="toggleBid()">BID</button>
          <button id="calc-btn" class="main-btn" onclick="doCalc()" disabled>CALC</button>
          <button id="next-btn" class="main-btn" onclick="handleNextClick()" disabled>NEXT</button>
        </div>

        <div class="player-panel player-right" id="panel-0">
          <div style="padding:8px 0;"><input type="text" value="MOHAMAD" id="name-0" class="p-name" style="color:#d32f2f"></div>
          <div style="padding:0 6px;">
            <select id="bid-0" class="bid-sel" onchange="syncBids()"></select>
            <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
              <button class="res-btn" id="w-0" onclick="setRes(0,'w')">W</button>
              <button class="res-btn" id="l-0" onclick="setRes(0,'l')">L</button>
            </div>
            <div id="pop-0" style="height:14px; font-weight:bold; margin-top:5px;"></div>
          </div>
          <div class="p-tot-display" id="tot-0" style="color:#d32f2f">0</div>
        </div>

        <div class="player-panel player-top" id="panel-1">
          <div style="padding:8px 0;"><input type="text" value="AMER" id="name-1" class="p-name"></div>
          <div style="padding:0 6px;">
            <select id="bid-1" class="bid-sel" onchange="syncBids()"></select>
            <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
              <button class="res-btn" id="w-1" onclick="setRes(1,'w')">W</button>
              <button class="res-btn" id="l-1" onclick="setRes(1,'l')">L</button>
            </div>
            <div id="pop-1" style="height:14px; font-weight:bold; margin-top:5px;"></div>
          </div>
          <div class="p-tot-display" id="tot-1">0</div>
        </div>

        <div class="player-panel player-left" id="panel-2">
          <div style="padding:8px 0;"><input type="text" value="WAEL" id="name-2" class="p-name" style="color:#d32f2f"></div>
          <div style="padding:0 6px;">
            <select id="bid-2" class="bid-sel" onchange="syncBids()"></select>
            <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
              <button class="res-btn" id="w-2" onclick="setRes(2,'w')">W</button>
              <button class="res-btn" id="l-2" onclick="setRes(2,'l')">L</button>
            </div>
            <div id="pop-2" style="height:14px; font-weight:bold; margin-top:5px;"></div>
          </div>
          <div class="p-tot-display" id="tot-2" style="color:#d32f2f">0</div>
        </div>

        <div class="player-panel player-bottom" id="panel-3">
          <div style="padding:8px 0;"><input type="text" value="AKRAM" id="name-3" class="p-name"></div>
          <div style="padding:0 6px;">
            <select id="bid-3" class="bid-sel" onchange="syncBids()"></select>
            <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
              <button class="res-btn" id="w-3" onclick="setRes(3,'w')">W</button>
              <button class="res-btn" id="l-3" onclick="setRes(3,'l')">L</button>
            </div>
            <div id="pop-3" style="height:14px; font-weight:bold; margin-top:5px;"></div>
          </div>
          <div class="p-tot-display" id="tot-3">0</div>
        </div>
      </div>
    </div>
    <div class="hist-container"><table><thead><tr><th>RD</th><th>Moh</th><th>Amer</th><th>Wael</th><th>Akr</th></tr></thead><tbody id="hist-body"></tbody></table></div>
  </div>

  <div id="win-banner"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC9bc2wY9HkQW9k5Ln-ha7hm0IQr_nHX7s",
      authDomain: "score-400-33dc7.firebaseapp.com",
      databaseURL: "https://score-400-33dc7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "score-400-33dc7",
      storageBucket: "score-400-33dc7.firebasestorage.app",
      messagingSenderId: "151401521482",
      appId: "1:151401521482:web:2d3ee46c226a15c18361b3",
      measurementId: "G-43ZD53RSTS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'gameState');

    let round=1, totals=[0,0,0,0], currentBids=[2,2,2,2], roundRes=[null,null,null,null], teamWins=[0,0], dealerIdx=3, history=[], bidsLocked=false, calced=false;
    const scoreMap = {2:2, 3:3, 4:4, 5:10, 6:6, 7:14, 8:16, 9:27, 10:40};
    const isAdmin = new URLSearchParams(window.location.search).get('role') === 'admin';

    if(isAdmin) document.getElementById('alz-btn').style.display='block';
    setTimeout(() => { document.getElementById('splash').style.opacity = '0'; setTimeout(() => document.getElementById('splash').remove(), 1000); }, 2000);

    onValue(dbRef, (snapshot) => {
      const data = snapshot.val();
      if(!data) return;
      round=data.round; totals=data.totals; teamWins=data.teamWins; dealerIdx=data.dealerIdx; history=data.history || [];
      currentBids=data.currentBids || [2,2,2,2]; bidsLocked=data.bidsLocked || false; calced=data.calced || false;
      
      document.getElementById('m1').innerText = teamWins[0];
      document.getElementById('m2').innerText = teamWins[1];
      let min = totals.some(t=>t>=40)?13:(totals.some(t=>t>=30)?12:11);
      document.getElementById('rd-info').innerText = `RD ${round} (${min})`;
      
      updateDropdowns();
      for(let i=0; i<4; i++){
        document.getElementById('tot-'+i).innerText = totals[i];
        document.getElementById('bid-'+i).value = currentBids[i];
        document.getElementById('bid-'+i).disabled = bidsLocked || !isAdmin;
      }
      
      const bBtn = document.getElementById('bid-btn');
      const cBtn = document.getElementById('calc-btn');
      const nBtn = document.getElementById('next-btn');

      if(!isAdmin) {
        bBtn.style.display='none'; cBtn.style.display='none'; nBtn.style.display='none';
        document.querySelectorAll('.res-btn').forEach(b => b.style.display='none');
      }

      bBtn.innerText = bidsLocked ? "REBID" : "BID";
      bBtn.className = bidsLocked ? "main-btn gray-btn" : "main-btn";
      cBtn.innerText = calced ? "RECALC" : "CALC";
      cBtn.className = calced ? "main-btn gray-btn" : "main-btn";
      cBtn.disabled = !bidsLocked;
      
      if(data.winnerData) {
          nBtn.innerText = (data.winnerData.type === "MATCH_OVER") ? "NEXT MATCH" : "NEXT GAME";
          nBtn.disabled = !isAdmin;
      } else {
          nBtn.innerText = "NEXT";
          nBtn.disabled = !calced;
      }

      document.querySelectorAll('.player-panel').forEach(p => p.classList.remove('dealer-active'));
      document.getElementById('panel-'+dealerIdx).classList.add('dealer-active');

      const hb = document.getElementById('hist-body'); hb.innerHTML = "";
      history.slice().reverse().forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.rd}</td><td>${row.s[0]}</td><td>${row.s[1]}</td><td>${row.s[2]}</td><td>${row.s[3]}</td>`;
        hb.appendChild(tr);
      });

      if(data.winnerData) showWinBanner(data.winnerData); else document.getElementById('win-banner').style.display='none';
    });

    window.syncBids = () => { if(isAdmin) update(dbRef, { currentBids: [0,1,2,3].map(i=>parseInt(document.getElementById('bid-'+i).value)) }); };

    window.toggleBid = () => {
      if(!isAdmin) return;
      if(!bidsLocked){
        let min = totals.some(t=>t>=40)?13:(totals.some(t=>t>=30)?12:11);
        let sum = [0,1,2,3].reduce((a,i)=>a+parseInt(document.getElementById('bid-'+i).value),0);
        if(sum<min) return alert("Min Bid: "+min);
        bidsLocked=true; for(let i=0;i<4;i++) setRes(i,'w');
      } else {
        bidsLocked=false; calced=false;
        for(let i=0;i<4;i++){ document.getElementById('pop-'+i).innerText=""; }
      }
      update(dbRef, { bidsLocked, calced });
    };

    window.setRes = (i,r) => {
      roundRes[i]=r;
      document.getElementById('w-'+i).style.background=(r==='w'?'#2e7d32':'');
      document.getElementById('l-'+i).style.background=(r==='l'?'#d32f2f':'');
    };

    window.doCalc = () => {
      if(!isAdmin) return;
      for(let i=0; i<4; i++){
        let b = parseInt(document.getElementById('bid-'+i).value);
        let s = (totals[i] < 30) ? (scoreMap[b] || b) : b;
        let final = (roundRes[i] === 'w') ? s : -s;
        document.getElementById('pop-'+i).innerText = (final > 0 ? "+" : "") + final;
        document.getElementById('bid-'+i).setAttribute('data-last', final);
      }
      calced = true; update(dbRef, { calced });
    };

    window.handleNextClick = () => {
      if(!isAdmin) return;
      // If a win was already triggered, Next resets for the next round
      onValue(dbRef, (snap) => {
        const d = snap.val();
        if(d && d.winnerData) { manualReset(d.winnerData.type === "MATCH_OVER"); return; }
      }, {onlyOnce: true});

      for(let i=0; i<4; i++) totals[i] += parseInt(document.getElementById('bid-'+i).getAttribute('data-last'));
      history.push({rd: round, s: [...totals]});

      let rW = (totals[0]>40||totals[2]>40)&&totals[0]>=0&&totals[2]>=0;
      let bW = (totals[1]>40||totals[3]>40)&&totals[1]>=0&&totals[3]>=0;

      if(rW || bW){
        let color = (totals[0]+totals[2] > totals[1]+totals[3]) ? 'red' : 'black';
        if(color==='red') teamWins[0]++; else teamWins[1]++;
        let target = parseInt(document.getElementById('match-type-select').value);
        let type = (teamWins[0] >= target || teamWins[1] >= target) ? "MATCH_OVER" : "GAME_OVER";
        update(dbRef, { teamWins, totals, history, winnerData: { type, color, n1:document.getElementById('name-0').value, s1:totals[0], n2:document.getElementById('name-2').value, s2:totals[2] } });
      } else {
        round++; dealerIdx=(dealerIdx+1)%4; bidsLocked=false; calced=false;
        update(dbRef, { round, totals, history, dealerIdx, bidsLocked, calced, currentBids:[2,2,2,2] });
      }
    };

    function updateDropdowns(){
      for(let i=0; i<4; i++){
        let sel = document.getElementById('bid-'+i);
        let prev = sel.value; sel.innerHTML='';
        let start = totals[i]>=40?4:(totals[i]>=30?3:2);
        for(let j=start; j<=10; j++){
          let opt=document.createElement('option'); opt.value=j; opt.innerText=j; sel.appendChild(opt);
        }
        if(prev) sel.value = prev; else sel.value = start;
      }
    }

    function showWinBanner(data){
      const banner = document.getElementById('win-banner');
      banner.style.display="block";
      banner.innerHTML = `<h2 style="color:#000; margin:0;">${data.type.replace('_',' ')}</h2>
      <h3 style="color:#d32f2f">TEAM ${data.color.toUpperCase()} WINS</h3>
      <p>Waiting for Admin to click NEXT...</p>`;
    }

    window.manualReset = (isMatch) => {
        let updateData = { totals:[0,0,0,0], round:1, history:[], bidsLocked:false, calced:false, currentBids:[2,2,2,2], winnerData:null, dealerIdx:(dealerIdx+1)%4 };
        if(isMatch) updateData.teamWins = [0,0];
        update(dbRef, updateData);
    };

    window.moveDealer = () => { dealerIdx=(dealerIdx+1)%4; update(dbRef, {dealerIdx}); };
  </script>
</body>
</html>